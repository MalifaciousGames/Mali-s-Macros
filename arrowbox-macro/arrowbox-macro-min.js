/* Mali's arrowbox macro */

(()=>{window.ArrowBox=class extends HTMLElement{static config={symbols:{prev:"<",next:">"}};constructor(){super();const e=document.createElement("button");e.innerHTML=this.constructor.config.symbols.prev,e.setAttribute("tabindex",-1),e.addEventListener("click",(()=>{this.select(this.valueIndex-1)}));const t=document.createElement("button");t.innerHTML=this.constructor.config.symbols.next,t.setAttribute("tabindex",-1),t.addEventListener("click",(()=>{this.select(this.valueIndex+1)}));const n=document.createElement("span");this.innerField=n,this.addEventListener("keyup",(e=>{switch(e.key){case"ArrowLeft":case"ArrowUp":return this.select(this.valueIndex-1);case"ArrowRight":case"ArrowDown":return this.select(this.valueIndex+1)}})),this.addEventListener("wheel",(e=>{this.select(this.valueIndex+(e.deltaY<0?1:-1)),e.preventDefault()})),this.valueIndex=0,requestAnimationFrame((()=>{this.append(e,n,t),this.setAttribute("tabindex",0);const s=this.options;if(s.length){const e=s.sort(((e,t)=>t.textContent.length-e.textContent.length))[0];this.innerField.style["min-width"]=e.textContent.length+"ch"}if(this.value)return this.innerField.innerHTML=this.value;let i=s.findIndex((e=>e.selected));-1===i&&(i=0),this.select(i)}))}get options(){const e=[...this.children];if(this.fromList){const t=document.getElementById(this.fromList);t&&e.push(...t.children)}return e.filter((e=>"OPTION"===e.tagName&&!e.disabled))}get selected(){return this.options[this.valueIndex]}select(e=this.valueIndex){const t=this.options;if(!t.length)return;for(;e<0;)e+=t.length;e%=t.length;const n=this.options[e];if(!n)throw new Error("No option at index "+e);this.valueIndex=e,this.setValue(n.value??n.textContent),this.innerField.innerHTML=n.textContent||n.value}setValue(e,t=!0){if(e=this.enforceType(e),this.value=e,!t)return;const n=new CustomEvent("change",{detail:{value:this.value,index:this.valueIndex}});this.dispatchEvent(n)}makeEditable(){this.editable=!0,this.innerField.setAttribute("tabindex",0),this.innerField.setAttribute("contenteditable",!0),this.innerField.setAttribute("spellcheck",!1),this.innerField.addEventListener("keydown",(e=>"Enter"===e.key||"Escape"===e.key?(this.focus(),this.setValue(this.innerField.textContent),!1):"number"!==this.type||1!==e.key.length||/[0-9\._]/.test(e.key)?void 0:(e.preventDefault(),!1)),!0),this.innerField.addEventListener("focusout",(()=>this.setValue(this.innerField.textContent))),this.innerField.addEventListener("keyup",(e=>{e.stopImmediatePropagation();const t=this.selected,n=e.target.textContent;t?t.value=t.innerHTML=n:this.setValue(n,!1),this.innerField.style["min-width"]=n.length+"ch"}))}enforceType(value){if(!this.type||"string"===this.type)return value;try{switch(this.type){case"number":return Number(value);case"json":return JSON.parse(value);case"eval":return eval(value)}}catch(e){return null}}static observedAttributes=["value","type","editable","list"];attributeChangedCallback(e,t,n){switch(e){case"value":const e=this.options.findIndex((e=>e.value===n||e.textContent===n));return-1!==e?this.select(e):this.setValue(n);case"editable":return null!==n&&this.makeEditable();case"type":return this.type=n?.toLowerCase();case"list":this.fromList=n}}},customElements.define("arrow-box",window.ArrowBox);const parseArgs=e=>{let t={},n=0;for(;n<e.length;){const s=e[n];if("object"==typeof s)Array.isArray(s)?e.splice(n--,1,...s):Object.assign(t,s);else{const i=e[n+=1];if(void 0===i)throw new Error("Uneven number of arguments.");if("string"!=typeof s)throw new Error(`Attribute key must be a string, reading: '${s}'.`);t[s.toLowerCase()]=i}n++}return t};Macro.add("arrowbox",{tags:["option","optionsfrom"],skipArgs:["optionsfrom"],isAsync:!0,handler(){const e=document.createElement("arrow-box"),t=parseArgs(this.args),n=[];for(const e of this.payload)if("optionsfrom"!==e.name)if("option"!==e.name);else{let t=!!e.args.deleteAll("selected").length,[s,i]=e.args;n.push({label:s,value:i??s,selected:t})}else{let t,s=e.args.full.startsWith("{")?`(${e.args.full})`:e.args.full;try{t=Scripting.evalJavaScript(s)}catch(e){return this.error("<<optionsfrom>> does not yield a valid collection.")}if("object"!=typeof t||null===t)return this.error("<<optionsfrom>> does not yield a valid collection.");if(t instanceof Array||t instanceof Set){for(const e of t)n.push({label:e,value:e});continue}if(t instanceof Map){for(const[e,s]of t)n.push({label:e,value:s});continue}for(const e in t)n.push({label:e,value:t[e]})}for(const t of n)$("<option>",{text:t.label,value:t.value,selected:t.selected}).appendTo(e);if(Object.hasOwn(t,"variable")){let n=t.variable;if("string"!=typeof n)return this.error(`Variable name must be a string, reading : ${n} (${typeof n})`);e.addEventListener("change",(e=>State.setVar(n,e.target.value))),delete t.variable}if(this.payload[0].contents.trim().length){const t=this.shadowHandler((()=>$.wiki(this.payload[0].contents)));e.addEventListener("change",t)}$(e).attr(t).addClass("macro-"+this.name).appendTo(this.output)}})})();