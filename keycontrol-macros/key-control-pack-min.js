/* KeyControl API, format-agnostic, only requires jQuery */

window.KeyControl=class{constructor(t,e){if("string"!=typeof t)throw new Error("Keybinding ID must be a string.");if(this.constructor.active.find((e=>e.id===t)))throw new Error(`A key listener with the ${t} ID already exists.`);this.id=t;for(const t in e)this[t]=e[t];if(!this.key)throw new Error("No input keys!");if("string"==typeof this.key&&(this.key=this.key.split(" ")),!Array.isArray(this.key))throw new Error("Improper key type, must be either a string or an array!");if("string"==typeof this.special&&(this.special=this.special.split(" ")),null!=this.special&&!Array.isArray(this.special))throw new Error("Improper special key, must be either a string or an array!");if(this.special?.some((t=>!["ctrl","alt","shift"].includes(t))))throw new Error("Special keys can only be: ctrl, shift or alt.");this.default={key:this.key,special:this.special};const i=this.keysFromMemory();if(i)for(const t in i)this[t]=i[t];if(null!=this.condition&&"function"!=typeof this.condition)throw new Error("Improper condition type, must be a function.");if("function"!=typeof this.callback)throw new Error("Improper callback type, must be a function.");this.active??=!0,this.setDisplay(),this.constructor.active.push(this)}invoke(t){this.key.find((e=>e===t.key||e===t.code))&&(this.special&&!this.special.every((e=>t[e+"Key"]))||this.condition&&!this.condition.call(this,t)||(this.callback.call(this,t),this.once&&this.delete()))}setKey(t,e){this.special=["ctrl","alt","shift"].filter((e=>t[e+"Key"])),e&&this.special.pushUnique(e),this.key=[t.key],this.keysToMemory(),this.setDisplay()}reset(){this.key=this.default.key,this.special=this.default.special,localStorage.removeItem(this.getMemoryId()),this.setDisplay()}setDisplay(){let t="";return this.special?.length&&(t+=this.special.join(" + ")+" + "),t+=this.key.join(" / "),this.displayVal=t}createInput(){return this.input=$("<input readonly>").attr({id:this.id,class:"keyInput",placeholder:"Enter key binding"}).val(this.displayVal),this.input.on("keydown",(t=>{"Tab"!==t.key&&(t.preventDefault(),t.stopPropagation(),this.setKey(t),this.input.val(this.displayVal))})).on("focus",(t=>this.input.val(""))).on("focusout",(t=>this.input.val(this.displayVal))),this.input}createResetButton(){return $("<button class='keyReset'>Reset to default</button>").attr({"aria-label":"Reset to default value",role:"button"}).on("click",(t=>{this.reset(),this.input.val(this.displayVal)}))}createInputContext(){const t=$("<div class='keyWrapper'>").append(`<span class='keyName'>${this.name??this.id}</span>`);return this.createInput().appendTo(t),this.createResetButton().appendTo(t),t}getMemoryId(){const t=$("tw-storydata")[0];return t.getAttribute("name")+":"+t.getAttribute("ifid")+":"+this.id}keysFromMemory(){const t=localStorage.getItem(this.getMemoryId());return t?JSON.parse(t):null}keysToMemory(){const t={key:this.key,special:this.special};localStorage.setItem(this.getMemoryId(),JSON.stringify(t))}delete(){const t=this.constructor.active,e=t.findIndex((t=>t===this));t.splice(e,1)}disable(){return this.active=!1}toggle(){return this.active=!this.active}enable(){return this.active=!0}static active=[];static coolDown=!1;static run(t){["input","textarea"].includes(t.target.nodeName.toLowerCase())||t.target.isContentEditable||this.coolDown||(this.coolDown=!0,setTimeout((()=>{this.coolDown=!1}),200),this.active.filter((t=>t.active)).forEach((e=>e.invoke(t))))}static add(t,e){return new this(t,e)}static get(t){const e=this.active.find((e=>e.id===t));if(!e)throw Error(`No listener found for the ${t} id.`);return e}static remove(t){this.get(t).delete()}static createInputPanel(){const t=$("<div class='keyInputPanel'>");return this.active.length?this.active.forEach((e=>t.append(e.createInputContext()))):t.append("<span>No active key bindings.</span>"),t}static openInputDialog(){if(!Dialog)throw new Error("KeyControl.openInputDialog() can only be used with the Sugarcube story format.");return Dialog.setup("Input panel","keyInputDialog"),Dialog.append(this.createInputPanel()).open()}},$(document).on("keydown.KeyControlAPI",(t=>KeyControl.run(t))),$("#style-story").before("<style id='KeyControlStyling'>\n.keyInputPanel {display:grid;}\n.keyWrapper {display: grid;grid-template-columns: 1fr 2fr 1fr;gap: 1em;padding: .5em;}\n</style>");

/* KeyControl macros for the Sugarcube story format */

Macro.add("bindkey",{tags:["condition","special"],handler(){if(!KeyControl)return this.error("This macro cannot be used without the KeyControl API.");if(this.args.length<2)return this.error("Macro requires at least two arguments: an id and a input key.");let[t,e,r]=this.args,n={};"object"!=typeof e||Array.isArray(e)||(n=e),n.name??=r??null,n.once??=this.args.includes("once"),n.key??=e,n.callback??=t=>$.wiki(this.payload[0].contents.trim());const i=this.payload.find((t=>"condition"===t.name));i&&(n.condition??=t=>Scripting.evalTwineScript(i.args[0]??i.contents.trim()));const s=this.payload.find((t=>"special"===t.name));s&&(n.special??=s.args.flat().map((t=>t.trim().toLowerCase()))),new KeyControl(t,n)}}),Macro.add(["keyinput","keysettings","keydialog"],{handler(){if(!KeyControl)return this.error("This macro cannot be used without the KeyControl API.");switch(this.name){case"keydialog":return KeyControl.openInputDialog();case"keysettings":return $(this.output).append(KeyControl.createInputPanel())}if(!this.args.length)return this.error("No supplied ID!");const t=KeyControl.get(this.args[0]);$(this.output).append(t[this.args[1]?"createInput":"createInputContext"]())}}),Macro.add("keyedit",{handler(){if(!KeyControl)return this.error("This macro cannot be used without the KeyControl API.");if(this.args.length<2)return this.error("Macro requires at least two arguments: a command and a listener id.");if("string"!=typeof this.args[0])return this.error("Command argument must be a string!");const t=this.args[0].trim().toLowerCase(),e=[];if(!["toggle","disable","enable","delete","reset"].includes(t))return this.error(`Command not recognized, reading: ${t}`);this.args.slice(1).forEach((t=>{if(Array.isArray(t))e.push(...t);else{if("string"!=typeof t)return this.error("IDs must be either strings or arrays of strings!");e.push(t)}})),e.forEach((e=>KeyControl.get(e)[t]()))}});

/* End of the KeyControl package */