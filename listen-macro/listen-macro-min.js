/* Mali's <<listen>> macro for Sugarcube */

Macro.add("listen",{tags:["when"],isAsync:!0,argsToObj:function(t){let e={},s=0;for(;s<t.length;){const i=t[s];if(Array.isArray(i))t.splice(s--,1,...i);else if("object"==typeof i)Object.assign(e,i);else{const n=t[s+=1];if(void 0===n)throw new Error("Uneven number of arguments.");e[i.toLowerCase()]=n}s++}return e},handler(){const t={},e=this.self.argsToObj(this.args),s=e.type||"span";delete e.type;const i=e.filter||null;delete e.filter;const n=e.initial;delete e.initial;for(const e of this.payload.slice(1)){let s=["change"];e.args.length&&(s=e.args.flat(1/0).map((t=>t.split(/\s|,/g))).flat().filter((t=>t)));for(const i of s)t[i]=e.contents}const o=(this.shadowHandler??this.createShadowWrapper)((e=>{try{State.temporary.event=e.originalEvent??e,$.wiki(t[e.type])}finally{delete State.temporary.event}}));if($(`<${s}>`,e).addClass(`macro-${this.name}`).wiki(this.payload[0].contents).on(Object.keys(t).join(" "),i,o).appendTo(this.output),"string"==typeof n)$.wiki(t[n]);else if(!0===n)for(const t of this.payload.slice(1))$.wiki(t.contents)}});